<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<!-- Meta tags for mobile -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="apple-touch-icon" href="meta/apple-touch-icon.png">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="720">
	<meta name="viewport" content="width=device-width, target-densitydpi=300dpi, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
	<meta name="format-detection" content="telephone=no" />


	<meta property="og:title" content="Bounce"/>
	<meta property="og:site_name" content="Bounce"/>
	<meta property="og:description" content="Tilt to stay on the platforms, don't hit the top or bottom of the screen. Also don't get Addicted!"/>
	<meta property="og:image" content="https://gyrobounce.herokuapp.com/meta/screenshot.png"/>

	<title>Pip Bounce</title>

	<style>
		html,body{
			margin:0;
    		background-color: #eee;
		}
		#canvas-container {
			width: 100%;
			text-align:center;
		}
		canvas{
    		background-color: white;
		}
	</style>
</head>

<body>
	<div id="canvas-container">
		<canvas id="canvas" width="200" height="100" style="border:0.5px #999">
		</canvas>
	</div>

	<script>
//0,0 is top left in Canvas
var player={};
var Gameover=true;
var eggTapped=false;
var eggCount=0;
var mobileRatio = 9/16;;
var scaling = window.devicePixelRatio;

var height = window.innerHeight * window.devicePixelRatio;
var width=window.innerWidth * window.devicePixelRatio * (9/16);


var gravity=.91/2 * scaling;
var blockspeed;
var gyro={};
var vgap = (height*1) / 3;
var keymovepower=0.55 * scaling;
var friction = 0.95;
var blockwidth=width*0.28;
var blockheight = height*0.035;
var jumpCountdown=0; // Ticks town to 0, if 0 can jump
var lastScore=0;
var blocks=[
{x:width/2,y:vgap,visibile:false},
{x:0,y:vgap*2},
{x:0,y:vgap*3}];
var leaderboard;
var score=0;
var imagenames=['fall_left.png','fall_right.png','up_left.png','up_right.png','egg_1.png','egg_2.png','egg_3.png','egg_4.png','egg_5.png'];
var sprites = [];
var pipsize=52*scaling;
// var pipsize=height * 0.045;
var currentSprite=0;
console.log("pipsize = " + pipsize);

function init() {

	document.getElementById("canvas").style.width = window.innerWidth * (9/16) + "px";
	document.getElementById("canvas").style.height = window.innerHeight + "px";


	for (var i = 0; i < imagenames.length; i++) {
		var drawing = new Image();
		drawing.src = 'pip/' + imagenames[i];
		sprites.push({name: imagenames[i],image:drawing});
	}

	getHighScores();

	score=0;

	blockspeed=-2*scaling; //Init Canvas
	canvas.width  = width
	canvas.height = height;
	canvas.imageSmoothingEnabled = true;

	player.x=width/2; //Init player
	player.y=80;
	player.xspeed=0;
	player.yspeed=0;

	//reset blocks except first so player can bounce on it
	blocks[0]={x:width/2 - (blockwidth/2),y:vgap,visibile:false};
	blocks[1]={x:width/2 - (blockwidth/2) ,y:vgap*2,visibile:true};
	for (var i = 2; i < blocks.length; i++) {
		// blocks[i].visibile=true
		blocks[i].y=vgap*(i+1);
		resetBlock(blocks[i]);
	}
}

function resetBlock(block){
	block.visibile=true
	block.x=Math.floor((Math.random() * (width - (blockwidth)  )) + 1);
}

function drawGame(){
	var ctx = canvas.getContext("2d");
	//draw Ball
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.beginPath();

	ctx.drawImage(sprites[currentSprite].image,player.x - (pipsize/2) ,player.y - pipsize/2,pipsize,pipsize);
	

	//Draw Blocks
	for (var i = 0; i < blocks.length; i++) {
		// Create gradient
		var block = blocks[i];
		var grd = ctx.createLinearGradient(0,0,width*0.75,0);
		grd.addColorStop(0,"red");
		grd.addColorStop(1,"purple");
		// Fill with gradient
		ctx.fillStyle = grd;
		if(block.visibile)
			ctx.fillRect(block.x,block.y,blockwidth,blockheight);
	}
	//Draw Text
	var ctx = canvas.getContext("2d");
	ctx.font = (18 * scaling) + "px Arial";
	ctx.textAlign="left"; 
	ctx.fillText("Score: " + Math.round(score) ,10,50);
	if (localStorage.highscore>0)
		ctx.fillText("High: " + Math.round(localStorage.highscore) ,10,80);
}

function updateGame(){
	score +=0.25;
	//Gravity + movement
	player.yspeed+=gravity;
	blockspeed-=0.001;
	if (jumpCountdown!=0)
		jumpCountdown--;
	//Calculate key movement for old school keyboards.
	if (keys[37])	//Left arrow
		player.xspeed-=keymovepower;
	if (keys[39])	//Right arrow
		player.xspeed+=keymovepower;
	//Calculate gyro into player pos
	if (gyro.beta)
		player.xspeed = (gyro.beta/10);
	player.xspeed*=friction;
	//Update player pos
	player.x+=player.xspeed;
	player.y+=player.yspeed;

	if (player.x<0)
		player.x=width;
	if (player.x>width)
		player.x=0;

	//Player Sprites
	if (player.xspeed<=0)
		currentSprite=0
	else currentSprite=1;

	if (jumpCountdown>0){
		currentSprite+=2;
	}


	//Gameover scenarios
	if (player.y > height || player.y<2){
		if (!localStorage.highscore)
			localStorage.highscore=0;
		if(score>localStorage.highscore){
			localStorage.highscore=score;
			postHighScore();
		}
		lastScore=score;
		Gameover=true;
		eggCount=3;
		init();	
	}

	for (var i = 0; i < blocks.length; i++) {
		var block = blocks[i];
		//Player Hit Detection of blocks, only if jump is not on cooldown
		if (jumpCountdown==0 && block.visibile!=false){
			var xdif=player.x-block.x;
			var ydif=player.y-block.y;				
			if (xdif >= 0 && xdif <= blockwidth ){ //x and y hit
				if (ydif>=0 &&  ydif <blockheight ){
					// console.log("The y IS TRUE");
					player.yspeed=blockspeed;
					player.yspeed-= (9 * scaling);
					jumpCountdown=30; //0.5 seconds
				}
			}
		}
		//Update blocks and reset y if off screen		
		block.y+=blockspeed;
		if(block.y < 0) { //reset blocks going off screen
			block.y=height;		
			resetBlock(block);
		}
	}
}

function drawMenu(){
	var ctx = canvas.getContext("2d");
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	var grd = ctx.createLinearGradient(0,0,width,0);
	grd.addColorStop(0,"red");
	grd.addColorStop(1,"purple");
	ctx.fillStyle = grd;
	ctx.font = (24 * scaling) + "px Arial";

	ctx.textAlign="center"; 
	if(lastScore)
		ctx.fillText("Last Score: " + Math.floor(lastScore),width/2,height/2 -100);
	// leaderboard
	if(leaderboard){
		ctx.fillText("Top 10 Leaderboard: \n",width/2,height/2 -20);
		ctx.font = (18 * scaling) + "px Arial";
		for (var i = 0; i < leaderboard.length; i++) {
			ctx.fillText((i + 1) + ": \n" + leaderboard[i].name +": "+ leaderboard[i].bestscore,width/2,height/2 + (22 * i));
			if (i==9)break;
		}
		
	}
	
	//draw pulsating circle
	ctx.beginPath();
	ctx.lineWidth=0.2;
	var d = new Date();
	var n = d.getMilliseconds();
	var delta = n/15;
	ctx.arc(width/2,82,20 + delta ,0,2*Math.PI * scaling);	
	ctx.stroke();
	//egg
	ctx.drawImage(sprites[4+eggCount].image,width/2 - (64/2 ) * scaling ,80 - 64/2 * scaling,64*scaling,64*scaling);

	if(keys[32] || keys[13]	){
		eggCount++;
		if (eggCount>3)
			Gameover=false;
	}

}

init();
	//Game Loop
	var ONE_FRAME_TIME = 1000 / 60 ;
	var mainloop = function() {
		if(!Gameover){
			updateGame();
			drawGame();
		}
		else
			drawMenu();

	};
	setInterval( mainloop, ONE_FRAME_TIME );

//add click listener
canvas.addEventListener("click", function(){
	console.log("Click");
	if(Gameover){
		eggCount++;
		if (eggCount>3)
			Gameover=false;
	}

});

function getHighScores(){
	var request = new XMLHttpRequest();
	request.open('GET', '/score.php', true);

	request.onload = function() {
		if (request.status >= 200 && request.status < 400) {
	    // Success!
	    var data = JSON.parse(request.responseText);
	    leaderboard=data;
	} else {
	    // We reached our target server, but it returned an error
	    console.log("failed getting high scores");
	}
};

request.onerror = function() {
	  // There was a connection error of some sort
	};

	request.send();
}

function postHighScore(){
	var name;
	if (!localStorage.name || localStorage.name=="null"){
		name = prompt("You have reach your personal high score! Please enter your name for the leaderboard: ");
		localStorage.name=name;
	}else{
		name=localStorage.name;
	}
	var request = new XMLHttpRequest();
	request.open('POST', '/score.php', true);
	request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
	request.onload = function() {
		getHighScores();
	};
	request.send("name="+name+"&score=" + localStorage.highscore);
}

//get orientation info, rolling back if gyro info not available
if (window.DeviceOrientationEvent) {//
	window.addEventListener("deviceorientation", function () {//gyro
		processGyro(event.beta, event.gamma, event.alpha); 
	}, true);
} 
var keys = [];
window.onkeyup = function(e) {keys[e.keyCode]=false;}
window.onkeydown = function(e) {keys[e.keyCode]=true;}

function processGyro(alpha,beta,gamma)
{
	gyro.alpha=alpha;
	gyro.beta=beta;
	gyro.gamma=gamma;
}
</script>
</body>
</html>
